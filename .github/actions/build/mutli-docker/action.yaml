name: Build mutli-Docker and Push to Registery
description: Build mutli-Docker and Push to Registery

inputs:
  ENVIRONMENT:
    description: "Environment name"
    default: "Release Candidate"
    required: false

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v3.2.0
      with:
        clean: false
        fetch-depth: "0"

    - name: ‚ùî Extract version
      uses: ./.github/actions/versioning/extract-version
      with:
        ENVIRONMENT: ${{ inputs.ENVIRONMENT }}

    - name: üêã Build Mongo Api 
      uses: ./.github/actions/build/docker
      with:
        IMAGE_NAME: "mongo-api"
        FOLDER_NAME: "./API"
        VERSION: ${{ env.VERSION }}

    # - name: üêã Build Arango Api 
    #   uses: ./.github/actions/build/docker
    #   with:
    #     IMAGE_NAME: "arango-api"
    #     FOLDER_NAME: "./ARANGO_API"
    #     VERSION: ${{ env.VERSION }}

    # - name: üêã Build BFF 
    #   uses: ./.github/actions/build/docker
    #   with:
    #     IMAGE_NAME: "ogree-bff"
    #     FOLDER_NAME: "./BFF"
    #     VERSION: ${{ env.VERSION }}

    - name: üêã Build Flutter App 
      uses: ./.github/actions/build/docker
      with:
        IMAGE_NAME: "ogree-app"
        FOLDER_NAME: "./APP"
        VERSION: ${{ env.VERSION }}

    - name: Publish CLI on Nexcloud
      uses: ./.github/actions/build/CLI
      with:
        VERSION: ${{ env.VERSION }}

    - name: ü™£ Init Git
      if: $ {{ !contains(inputs.ENVIRONMENT, 'Candidate') }}
      shell: bash
      run: |
        git config --global user.email "svc@users.noreply.github.com"
        git config --global user.name "svc"

    - name: üè∑Ô∏è Create tag if release
      if: $ {{ !contains(inputs.ENVIRONMENT, 'Candidate') }}
      shell: bash
      run: |
        TAG_MSG=$(echo ${{ inputs.ENVIRONMENT }} | cut -d'-' -f 2)
        git tag -a ${{ env.VERSION }} -m "${TAG_MSG} ${{ env.VERSION }}" -f

    - name: ‚¨ÜÔ∏è Push changes
      if: $ {{ !contains(inputs.ENVIRONMENT, 'Candidate') }}
      uses: ad-m/github-push-action@master
      with:
        branch: ${{ github.ref }}
        tags: true
        force: true
