name: Build multi-Docker and Push to Registery
description: Build multi-Docker and Push to Registery

inputs:
  ENVIRONMENT:
    description: "Environment name"
    default: "Release Candidate"
    required: false
  TEAM_DOCKER_URL:
    description: "docker url"
    required: true
  TEAM_USERNAME:
    description: "docker username"
    required: true
  TEAM_PASSWORD:
    description: "docker password"
    required: true
  NEXT_CREDENTIALS:
    description: "NEXT_CREDENTIALS"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v3.2.0
      with:
        clean: false
        fetch-depth: "0"

    - name: ‚ùî Extract project version
      shell: bash
      run: |
        VERSION=$( echo ${{ github.ref_name }} | sed -e "s/release.*\///g")
        if [[ "${{ env.ENVIRONMENT }}" == "Release Candidate" ]]; then
          VERSION=${VERSION}.rc
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: üêã Build Mongo Api
      uses: ./.github/actions/build/docker
      with:
        IMAGE_NAME: "mongo-api"
        FOLDER_NAME: "./API"
        VERSION: ${{ env.VERSION }}
        TEAM_DOCKER_URL: ${{ inputs.TEAM_DOCKER_URL }}
        TEAM_USERNAME: ${{ inputs.TEAM_USERNAME }}
        TEAM_PASSWORD: ${{ inputs.TEAM_PASSWORD }}

    # - name: üêã Build Arango Api 
    #   uses: ./.github/actions/build/docker
    #   with:
    #     IMAGE_NAME: "arango-api"
    #     FOLDER_NAME: "./ARANGO_API"
    #     VERSION: ${{ env.VERSION }}
    #     TEAM_DOCKER_URL: ${{ inputs.TEAM_DOCKER_URL }}
    #     TEAM_USERNAME: ${{ inputs.TEAM_USERNAME }}
    #     TEAM_PASSWORD: ${{ inputs.TEAM_PASSWORD }}
    
    # - name: üêã Build BFF 
    #   uses: ./.github/actions/build/docker
    #   with:
    #     IMAGE_NAME: "ogree-bff"
    #     FOLDER_NAME: "./BFF"
    #     VERSION: ${{ env.VERSION }}
    #     TEAM_DOCKER_URL: ${{ inputs.TEAM_DOCKER_URL }}
    #     TEAM_USERNAME: ${{ inputs.TEAM_USERNAME }}
    #     TEAM_PASSWORD: ${{ inputs.TEAM_PASSWORD }}

    - name: üêã Build Flutter App 
      uses: ./.github/actions/build/docker
      with:
        IMAGE_NAME: "ogree-app"
        FOLDER_NAME: "./APP"
        VERSION: ${{ env.VERSION }}
        TEAM_DOCKER_URL: ${{ inputs.TEAM_DOCKER_URL }}
        TEAM_USERNAME: ${{ inputs.TEAM_USERNAME }}
        TEAM_PASSWORD: ${{ inputs.TEAM_PASSWORD }}

    - name: üêã Build Kube Backend 
      uses: ./.github/actions/build/docker
      with:
        IMAGE_NAME: "kube-admin"
        FOLDER_NAME: "./BACK/kube-backend/kube-admin"
        VERSION: ${{ env.VERSION }}
        TEAM_DOCKER_URL: ${{ inputs.TEAM_DOCKER_URL }}
        TEAM_USERNAME: ${{ inputs.TEAM_USERNAME }}
        TEAM_PASSWORD: ${{ inputs.TEAM_PASSWORD }}

    - name: Publish CLI on Nexcloud
      uses: ./.github/actions/build/CLI
      with:
        VERSION: ${{ env.VERSION }}
        NEXT_CREDENTIALS: ${{ inputs.NEXT_CREDENTIALS }}
    
    - name: Publish Flutter Desktop on Nexcloud
      uses: ./.github/actions/build/flutter-app/linux
      with:
        VERSION: ${{ env.VERSION }}
        NEXT_CREDENTIALS: ${{ inputs.NEXT_CREDENTIALS }}
    
    - name: Publish back-app on Nexcloud
      uses: ./.github/actions/build/back-app/linux
      with:
        VERSION: ${{ env.VERSION }}
        NEXT_CREDENTIALS: ${{ inputs.NEXT_CREDENTIALS }}

    - name: ü™£ Init Git
      if: ${{ !contains(inputs.ENVIRONMENT, 'Candidate') }}
      shell: bash
      run: |
        git config --global user.email "svc@users.noreply.github.com"
        git config --global user.name "svc"

    - name: üè∑Ô∏è Create tag if release
      if: ${{ !contains(inputs.ENVIRONMENT, 'Candidate') }}
      shell: bash
      run: |
        TAG_MSG=$(echo ${{ inputs.ENVIRONMENT }} | cut -d'-' -f 2)
        git tag -a ${{ env.VERSION }} -m "${TAG_MSG} ${{ env.VERSION }}" -f

    - name: Download all artifacts
      uses: actions/download-artifact@v3
    
    - name: üè∑Ô∏è Create release if release
      if: ${{ !contains(inputs.ENVIRONMENT, 'Candidate') }}
      uses: softprops/action-gh-release@v1
      with:
          tag_name: ${{ env.VERSION }}
          files: |
            CLI/cli
            cli
            cli.mac
            ogree-app-installer.exe
            app-win-installer
            CLI/cli.mac
            CLI/LICENSE

    - name: ‚¨ÜÔ∏è Push changes
      if: ${{ !contains(inputs.ENVIRONMENT, 'Candidate') }}
      uses: ad-m/github-push-action@master
      with:
        branch: ${{ github.ref }}
        tags: true
        force: true
