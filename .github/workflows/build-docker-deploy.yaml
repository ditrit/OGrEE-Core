name: ‚öôÔ∏è Build - Push to Registery

on:
  push:
    branches:
      - "release/**"
      - "release-candidate/**"
  workflow_dispatch:
  workflow_call:

jobs:
  build-docker:
    name: üèóÔ∏èüì§ Build Docker Image - Push to Registery
    permissions: write-all
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v4
        with:
          clean: false
          fetch-depth: "0"

      - name: üåç Set environment
        id: set-environment
        run: |
          if [[ "${{ github.ref_name }}" == "release/"* ]]; then
          echo "ENVIRONMENT=Release" >> $GITHUB_ENV
          else 
          echo "ENVIRONMENT=Release Candidate" >> $GITHUB_ENV
          fi

      - name: üèóÔ∏èüì§ Build Docker Image - Push to Registery
        id: build-docker-deploy
        if: contains("release",${{ github.ref_name }})
        uses: ./.github/actions/build/multi-docker
        with:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          TEAM_DOCKER_URL: ${{ secrets.TEAM_DOCKER_URL }}
          TEAM_USERNAME: ${{ secrets.TEAM_DOCKER_USERNAME }}
          TEAM_PASSWORD: ${{ secrets.TEAM_DOCKER_PASSWORD }}
          NEXT_CREDENTIALS: ${{ secrets.NEXT_CREDENTIALS }}
  
  build-app-windows:
    name: üèóÔ∏èüì§ Build APP and Installer for Windows
    permissions: write-all
    needs: build-docker
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          clean: false
          fetch-depth: "0"
      - name: ‚ùî Extract project version
        shell: bash
        run: |
          VERSION=$( echo ${{ github.ref_name }} | sed -e "s/release.*\///g")
          if [[ ${{ github.ref_name }} != "release/"* ]]; then
            VERSION=${VERSION}.rc
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: üèóÔ∏èüì§ Build app and create installer
        uses: ./.github/actions/build/windows
        with:
          VERSION: ${{ env.VERSION }}
          NEXT_CREDENTIALS: ${{ secrets.NEXT_CREDENTIALS }}

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Display structure of downloaded files
        run: ls -R

      - name: üè∑Ô∏è Create release if release
        if: ${{ !contains(env.ENVIRONMENT, 'Candidate') }}
        uses: softprops/action-gh-release@v1
        with:
            tag_name: ${{ env.VERSION }}
            files: |
              cli-build/cli.exe
              cli-build/cli
              cli-build/cli.mac
              api-build/OGrEE_API_Linux_x64
              api-build/OGrEE_API_OSX_x64
              api-build/OGrEE_API_Win_x64
              app-web-build/OGrEE_APP_Web.zip
              app-win-build/OGrEE_Win_Install.exe

  
